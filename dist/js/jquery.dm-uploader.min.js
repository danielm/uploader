/*
 * dmUploader - jQuery Ajax File Uploader Widget
 * https://github.com/danielm/uploader
 *
 * Copyright Daniel Morales <daniel85mg@gmail.com>
 * Released under the MIT license.
 * https://github.com/danielm/uploader/blob/master/LICENSE.txt
 *
 * @preserve
 */
!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery"],e):"undefined"!=typeof exports?module.exports=e(require("jquery")):e(window.jQuery)}(function(s){"use strict";var o="dmUploader",n=0,r=1,t=2,i=3,a=4,u={auto:!0,queue:!0,dnd:!0,hookDocument:!0,multiple:!0,url:document.URL,method:"POST",extraData:{},headers:{},dataType:null,fieldName:"file",maxFileSize:0,allowedTypes:"*",extFilter:null,onInit:function(){},onComplete:function(){},onFallbackMode:function(){},onNewFile:function(){},onBeforeUpload:function(){},onUploadProgress:function(){},onUploadSuccess:function(){},onUploadCanceled:function(){},onUploadError:function(){},onUploadComplete:function(){},onFileTypeError:function(){},onFileSizeError:function(){},onFileExtError:function(){},onDragEnter:function(){},onDragLeave:function(){},onDocumentDragEnter:function(){},onDocumentDragLeave:function(){}},l=function(e,t){this.data=e,this.widget=t,this.jqXHR=null,this.status=n,this.id=Math.random().toString(36).substr(2)};l.prototype.upload=function(){var i=this;if(!i.canUpload())return i.widget.queueRunning&&i.status!==r&&i.widget.processQueue(),!1;var n=new FormData;n.append(i.widget.settings.fieldName,i.data);var e=i.widget.settings.extraData;return"function"==typeof e&&(e=e.call(i.widget.element,i.id)),s.each(e,function(e,t){n.append(e,t)}),i.status=r,i.widget.activeFiles++,i.widget.settings.onBeforeUpload.call(i.widget.element,i.id),i.jqXHR=s.ajax({url:i.widget.settings.url,type:i.widget.settings.method,dataType:i.widget.settings.dataType,data:n,headers:i.widget.settings.headers,cache:!1,contentType:!1,processData:!1,forceSync:!1,xhr:function(){return i.getXhr()},success:function(e){i.onSuccess(e)},error:function(e,t,n){i.onError(e,t,n)},complete:function(){i.onComplete()}}),!0},l.prototype.onSuccess=function(e){this.status=t,this.widget.settings.onUploadSuccess.call(this.widget.element,this.id,e)},l.prototype.onError=function(e,t,n){this.status!==a&&(this.status=i,this.widget.settings.onUploadError.call(this.widget.element,this.id,e,t,n))},l.prototype.onComplete=function(){this.widget.activeFiles--,this.status!==a&&this.widget.settings.onUploadComplete.call(this.widget.element,this.id),this.widget.queueRunning?this.widget.processQueue():this.widget.settings.queue&&0===this.widget.activeFiles&&this.widget.settings.onComplete.call(this.element)},l.prototype.getXhr=function(){var o=this,e=s.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){var t=0,n=e.loaded||e.position,i=e.total||e.totalSize;e.lengthComputable&&(t=Math.ceil(n/i*100)),o.widget.settings.onUploadProgress.call(o.widget.element,o.id,t)},!1),e},l.prototype.cancel=function(e){e=void 0!==e&&e;var t=this.status;return!!(t===r||e&&t===n)&&(this.status=a,this.widget.settings.onUploadCanceled.call(this.widget.element,this.id),t===r&&this.jqXHR.abort(),!0)},l.prototype.canUpload=function(){return this.status===n||this.status===i};var d=function(e,t){return this.element=s(e),this.settings=s.extend({},u,t),this.checkSupport()?(this.init(),this):(s.error("Browser not supported by jQuery.dmUploader"),this.settings.onFallbackMode.call(this.element),!1)};d.prototype.checkSupport=function(){return void 0!==window.FormData&&(!new RegExp("/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle/(1.0|2.0|2.5|3.0))/").test(window.navigator.userAgent)&&!s('<input type="file" />').prop("disabled"))},d.prototype.init=function(){var n=this;this.queue=[],this.queuePos=-1,this.queueRunning=!1,this.activeFiles=0,this.draggingOver=0,this.draggingOverDoc=0;var e=n.element.is("input[type=file]")?n.element:n.element.find("input[type=file]");return 0<e.length&&(e.prop("multiple",this.settings.multiple),e.on("change."+o,function(e){var t=e.target&&e.target.files;t&&t.length&&(n.addFiles(t),s(this).val(""))})),this.settings.dnd&&this.initDnD(),0!==e.length||this.settings.dnd?(this.settings.onInit.call(this.element),this):(s.error("Markup error found by jQuery.dmUploader"),null)},d.prototype.initDnD=function(){var i=this;i.element.on("drop."+o,function(e){e.preventDefault(),e.stopPropagation(),0<i.draggingOver&&(i.draggingOver=0,i.settings.onDragLeave.call(i.element));var t=e.originalEvent&&e.originalEvent.dataTransfer;if(t&&t.files&&t.files.length){var n=[];i.settings.multiple?n=t.files:n.push(t.files[0]),i.addFiles(n)}}),i.element.on("dragenter."+o,function(e){e.preventDefault(),e.stopPropagation(),0===i.draggingOver&&i.settings.onDragEnter.call(i.element),i.draggingOver++}),i.element.on("dragleave."+o,function(e){e.preventDefault(),e.stopPropagation(),i.draggingOver--,0===i.draggingOver&&i.settings.onDragLeave.call(i.element)}),i.settings.hookDocument&&(s(document).off("drop."+o).on("drop."+o,function(e){e.preventDefault(),e.stopPropagation(),0<i.draggingOverDoc&&(i.draggingOverDoc=0,i.settings.onDocumentDragLeave.call(i.element))}),s(document).off("dragenter."+o).on("dragenter."+o,function(e){e.preventDefault(),0===i.draggingOverDoc&&i.settings.onDocumentDragEnter.call(i.element),i.draggingOverDoc++}),s(document).off("dragleave."+o).on("dragleave."+o,function(e){e.preventDefault(),e.stopPropagation(),i.draggingOverDoc--,0===i.draggingOverDoc&&i.settings.onDocumentDragLeave.call(i.element)}),s(document).off("dragover."+o).on("dragover."+o,function(e){e.preventDefault(),e.stopPropagation()}))},d.prototype.releaseEvents=function(){this.element.off("."+o),this.element.find("input[type=file]").off("."+o),this.settings.hookDocument&&s(document).off("."+o)},d.prototype.validateFile=function(e){if(0<this.settings.maxFileSize&&e.size>this.settings.maxFileSize)return this.settings.onFileSizeError.call(this.element,e),!1;if("*"!==this.settings.allowedTypes&&!e.type.match(this.settings.allowedTypes))return this.settings.onFileTypeError.call(this.element,e),!1;if(null!==this.settings.extFilter){var t=e.name.toLowerCase().split(".").pop();if(s.inArray(t,this.settings.extFilter)<0)return this.settings.onFileExtError.call(this.element,e),!1}return new l(e,this)},d.prototype.addFiles=function(e){for(var t=0,n=0;n<e.length;n++){var i=this.validateFile(e[n]);if(i)!1!==this.settings.onNewFile.call(this.element,i.id,i.data)&&(this.settings.auto&&!this.settings.queue&&i.upload(),this.queue.push(i),t++)}return 0===t||this.settings.auto&&this.settings.queue&&!this.queueRunning&&this.processQueue(),this},d.prototype.processQueue=function(){return this.queuePos++,this.queuePos>=this.queue.length?(0===this.activeFiles&&this.settings.onComplete.call(this.element),this.queuePos=this.queue.length-1,this.queueRunning=!1):(this.queueRunning=!0,this.queue[this.queuePos].upload())},d.prototype.restartQueue=function(){this.queuePos=-1,this.queueRunning=!1,this.processQueue()},d.prototype.findById=function(e){for(var t=!1,n=0;n<this.queue.length;n++)if(this.queue[n].id===e){t=this.queue[n];break}return t},d.prototype.cancelAll=function(){var e=this.queueRunning;this.queueRunning=!1;for(var t=0;t<this.queue.length;t++)this.queue[t].cancel();e&&this.settings.onComplete.call(this.element)},d.prototype.startAll=function(){if(this.settings.queue)this.restartQueue();else for(var e=0;e<this.queue.length;e++)this.queue[e].upload()},d.prototype.methods={start:function(e){if(this.queueRunning)return!1;var t=!1;return void 0===e||(t=this.findById(e))?t?(t.status===a&&(t.status=n),t.upload()):(this.startAll(),!0):(s.error("File not found in jQuery.dmUploader"),!1)},cancel:function(e){var t=!1;return void 0===e||(t=this.findById(e))?t?t.cancel(!0):(this.cancelAll(),!0):(s.error("File not found in jQuery.dmUploader"),!1)},reset:function(){return this.cancelAll(),this.queue=[],this.queuePos=-1,!(this.activeFiles=0)},destroy:function(){this.cancelAll(),this.releaseEvents(),this.element.removeData(o)}},s.fn.dmUploader=function(t){var n=arguments;if("string"!=typeof t)return this.each(function(){s.data(this,o)||s.data(this,o,new d(this,t))});this.each(function(){var e=s.data(this,o);e instanceof d?"function"==typeof e.methods[t]?e.methods[t].apply(e,Array.prototype.slice.call(n,1)):s.error("Method "+t+" does not exist in jQuery.dmUploader"):s.error("Unknown plugin data found by jQuery.dmUploader")})}});