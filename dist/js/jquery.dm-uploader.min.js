/*
 * dmUploader - jQuery Ajax File Uploader Widget
 * https://github.com/danielm/uploader
 *
 * Copyright Daniel Morales <daniel85mg@gmail.com>
 * Released under the MIT license.
 * https://github.com/danielm/uploader/blob/master/LICENSE.txt
 *
 *
 * Nikitul: Added the posibility to remove file from queue
 *
 * @preserve
 */
!function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery"],factory):"undefined"!=typeof exports?module.exports=factory(require("jquery")):factory(window.jQuery)}((function($){"use strict";var pluginName="dmUploader",FileStatus_PENDING=0,FileStatus_UPLOADING=1,FileStatus_COMPLETED=2,FileStatus_FAILED=3,FileStatus_CANCELLED=4,defaults={auto:!0,queue:!0,dnd:!0,hookDocument:!0,multiple:!0,url:document.URL,method:"POST",extraData:{},headers:{},dataType:null,fieldName:"file",maxFileSize:0,allowedTypes:"*",extFilter:null,onInit:function(){},onComplete:function(){},onFallbackMode:function(){},onNewFile:function(){},onRemoveFile:function(){},onBeforeUpload:function(){},onUploadProgress:function(){},onUploadSuccess:function(){},onUploadCanceled:function(){},onUploadError:function(){},onUploadComplete:function(){},onFileTypeError:function(){},onFileSizeError:function(){},onFileExtError:function(){},onDragEnter:function(){},onDragLeave:function(){},onDocumentDragEnter:function(){},onDocumentDragLeave:function(){}},DmUploaderFile=function(file,widget){this.data=file,this.widget=widget,this.jqXHR=null,this.status=FileStatus_PENDING,this.id=Math.random().toString(36).substr(2)};DmUploaderFile.prototype.upload=function(){var file=this;if(!file.canUpload())return file.widget.queueRunning&&file.status!==FileStatus_UPLOADING&&file.widget.processQueue(),!1;var fd=new FormData;fd.append(file.widget.settings.fieldName,file.data);var customData=file.widget.settings.extraData;return"function"==typeof customData&&(customData=customData.call(file.widget.element,file.id)),$.each(customData,(function(exKey,exVal){fd.append(exKey,exVal)})),file.status=FileStatus_UPLOADING,file.widget.activeFiles++,file.widget.settings.onBeforeUpload.call(file.widget.element,file.id),file.jqXHR=$.ajax({url:file.widget.settings.url,type:file.widget.settings.method,dataType:file.widget.settings.dataType,data:fd,headers:file.widget.settings.headers,cache:!1,contentType:!1,processData:!1,forceSync:!1,xhr:function(){return file.getXhr()},success:function(data){file.onSuccess(data)},error:function(xhr,status,errMsg){file.onError(xhr,status,errMsg)},complete:function(){file.onComplete()}}),!0},DmUploaderFile.prototype.onSuccess=function(data){this.status=FileStatus_COMPLETED,this.widget.settings.onUploadSuccess.call(this.widget.element,this.id,data)},DmUploaderFile.prototype.onError=function(xhr,status,errMsg){this.status!==FileStatus_CANCELLED&&(this.status=FileStatus_FAILED,this.widget.settings.onUploadError.call(this.widget.element,this.id,xhr,status,errMsg))},DmUploaderFile.prototype.onComplete=function(){this.widget.activeFiles--,this.status!==FileStatus_CANCELLED&&this.widget.settings.onUploadComplete.call(this.widget.element,this.id),this.widget.queueRunning?this.widget.processQueue():this.widget.settings.queue&&0===this.widget.activeFiles&&this.widget.settings.onComplete.call(this.element)},DmUploaderFile.prototype.getXhr=function(){var file=this,xhrobj=$.ajaxSettings.xhr();return xhrobj.upload&&xhrobj.upload.addEventListener("progress",(function(event){var percent=0,position=event.loaded||event.position,total=event.total||event.totalSize;event.lengthComputable&&(percent=Math.ceil(position/total*100)),file.widget.settings.onUploadProgress.call(file.widget.element,file.id,percent)}),!1),xhrobj},DmUploaderFile.prototype.cancel=function(abort){abort=void 0!==abort&&abort;var myStatus=this.status;return!!(myStatus===FileStatus_UPLOADING||abort&&myStatus===FileStatus_PENDING)&&(this.status=FileStatus_CANCELLED,this.widget.settings.onUploadCanceled.call(this.widget.element,this.id),myStatus===FileStatus_UPLOADING&&this.jqXHR.abort(),!0)},DmUploaderFile.prototype.canUpload=function(){return this.status===FileStatus_PENDING||this.status===FileStatus_FAILED};var DmUploader=function(element,options){return this.element=$(element),this.settings=$.extend({},defaults,options),this.checkSupport()?(this.init(),this):($.error("Browser not supported by jQuery.dmUploader"),this.settings.onFallbackMode.call(this.element),!1)};DmUploader.prototype.checkSupport=function(){return void 0!==window.FormData&&(!new RegExp("/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle/(1.0|2.0|2.5|3.0))/").test(window.navigator.userAgent)&&!$('<input type="file" />').prop("disabled"));var exp},DmUploader.prototype.init=function(){var widget=this;this.queue=[],this.queuePos=-1,this.queueRunning=!1,this.activeFiles=0,this.draggingOver=0,this.draggingOverDoc=0;var input=widget.element.is("input[type=file]")?widget.element:widget.element.find("input[type=file]");return input.length>0&&(input.prop("multiple",this.settings.multiple),input.on("change.dmUploader",(function(evt){var files=evt.target&&evt.target.files;files&&files.length&&(widget.addFiles(files),$(this).val(""))}))),this.settings.dnd&&this.initDnD(),0!==input.length||this.settings.dnd?(this.settings.onInit.call(this.element),this):($.error("Markup error found by jQuery.dmUploader"),null)},DmUploader.prototype.initDnD=function(){var widget=this;widget.element.on("drop.dmUploader",(function(evt){evt.preventDefault(),widget.draggingOver>0&&(widget.draggingOver=0,widget.settings.onDragLeave.call(widget.element));var dataTransfer=evt.originalEvent&&evt.originalEvent.dataTransfer;if(dataTransfer&&dataTransfer.files&&dataTransfer.files.length){var files=[];widget.settings.multiple?files=dataTransfer.files:files.push(dataTransfer.files[0]),widget.addFiles(files)}})),widget.element.on("dragenter.dmUploader",(function(evt){evt.preventDefault(),0===widget.draggingOver&&widget.settings.onDragEnter.call(widget.element),widget.draggingOver++})),widget.element.on("dragleave.dmUploader",(function(evt){evt.preventDefault(),widget.draggingOver--,0===widget.draggingOver&&widget.settings.onDragLeave.call(widget.element)})),widget.settings.hookDocument&&($(document).off("drop.dmUploader").on("drop.dmUploader",(function(evt){evt.preventDefault(),widget.draggingOverDoc>0&&(widget.draggingOverDoc=0,widget.settings.onDocumentDragLeave.call(widget.element))})),$(document).off("dragenter.dmUploader").on("dragenter.dmUploader",(function(evt){evt.preventDefault(),0===widget.draggingOverDoc&&widget.settings.onDocumentDragEnter.call(widget.element),widget.draggingOverDoc++})),$(document).off("dragleave.dmUploader").on("dragleave.dmUploader",(function(evt){evt.preventDefault(),widget.draggingOverDoc--,0===widget.draggingOverDoc&&widget.settings.onDocumentDragLeave.call(widget.element)})),$(document).off("dragover.dmUploader").on("dragover.dmUploader",(function(evt){evt.preventDefault()})))},DmUploader.prototype.releaseEvents=function(){this.element.off(".dmUploader"),this.element.find("input[type=file]").off(".dmUploader"),this.settings.hookDocument&&$(document).off(".dmUploader")},DmUploader.prototype.validateFile=function(file){if(this.settings.maxFileSize>0&&file.size>this.settings.maxFileSize)return this.settings.onFileSizeError.call(this.element,file),!1;if("*"!==this.settings.allowedTypes&&!file.type.match(this.settings.allowedTypes))return this.settings.onFileTypeError.call(this.element,file),!1;if(null!==this.settings.extFilter){var ext=file.name.toLowerCase().split(".").pop();if($.inArray(ext,this.settings.extFilter)<0)return this.settings.onFileExtError.call(this.element,file),!1}return new DmUploaderFile(file,this)},DmUploader.prototype.addFiles=function(files){for(var nFiles=0,i=0;i<files.length;i++){var file=this.validateFile(files[i]),can_continue;if(file)!1!==this.settings.onNewFile.call(this.element,file.id,file.data)&&(this.settings.auto&&!this.settings.queue&&file.upload(),this.queue.push(file),nFiles++)}return 0===nFiles?this:(this.settings.auto&&this.settings.queue&&!this.queueRunning&&this.processQueue(),this)},DmUploader.prototype.removeFiles=function(files){var nFiles=0,index,queueWasRunning=this.queueRunning;this.queueRunning=!1;for(var i=0;i<files.length;i++){var file=files[i],can_continue;file.cancel(!0),(index=this.queue.indexOf(file))>-1&&this.queue.splice(index,1),!1!==this.settings.onRemoveFile.call(this.element,file.id,file.data)&&nFiles++}return queueWasRunning&&this.restartQueue(),this},DmUploader.prototype.processQueue=function(){return this.queuePos++,this.queuePos>=this.queue.length?(0===this.activeFiles&&this.settings.onComplete.call(this.element),this.queuePos=this.queue.length-1,this.queueRunning=!1,!1):(this.queueRunning=!0,this.queue[this.queuePos].upload())},DmUploader.prototype.restartQueue=function(){this.queuePos=-1,this.queueRunning=!1,this.processQueue()},DmUploader.prototype.findById=function(id){for(var r=!1,i=0;i<this.queue.length;i++)if(this.queue[i].id===id){r=this.queue[i];break}return r},DmUploader.prototype.cancelAll=function(){var queueWasRunning=this.queueRunning;this.queueRunning=!1;for(var i=0;i<this.queue.length;i++)this.queue[i].cancel();queueWasRunning&&this.settings.onComplete.call(this.element)},DmUploader.prototype.startAll=function(){if(this.settings.queue)this.restartQueue();else for(var i=0;i<this.queue.length;i++)this.queue[i].upload()},DmUploader.prototype.methods={start:function(id){if(this.queueRunning)return!1;var file=!1;return void 0===id||(file=this.findById(id))?file?(file.status===FileStatus_CANCELLED&&(file.status=FileStatus_PENDING),file.upload()):(this.startAll(),!0):($.error("File not found in jQuery.dmUploader"),!1)},cancel:function(id){var file=!1;return void 0===id||(file=this.findById(id))?file?file.cancel(!0):(this.cancelAll(),!0):($.error("File not found in jQuery.dmUploader"),!1)},remove:function(id){var file=!1;return void 0===id||(file=this.findById(id))?(this.removeFiles([file]),!0):($.error("File not found in jQuery.dmUploader"),!1)},reset:function(){return this.cancelAll(),this.queue=[],this.queuePos=-1,this.activeFiles=0,!0},destroy:function(){this.cancelAll(),this.releaseEvents(),this.element.removeData(pluginName)}},$.fn.dmUploader=function(options){var args=arguments;if("string"!=typeof options)return this.each((function(){$.data(this,pluginName)||$.data(this,pluginName,new DmUploader(this,options))}));this.each((function(){var plugin=$.data(this,pluginName);plugin instanceof DmUploader?"function"==typeof plugin.methods[options]?plugin.methods[options].apply(plugin,Array.prototype.slice.call(args,1)):$.error("Method "+options+" does not exist in jQuery.dmUploader"):$.error("Unknown plugin data found by jQuery.dmUploader")}))}}));