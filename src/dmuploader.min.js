/*
* dmuploader.js - Jquery File Uploader - 0.1
* http://www.daniel.com.uy/projects/jquery-file-uploader/
*
* Copyright (c) 2013-2014 Daniel Morales
* Dual licensed under the MIT and GPL licenses.
* http://www.daniel.com.uy/doc/license/
*/
!function(e){var t="dmUploader",n={PENDING:0,UPLOADING:1,COMPLETED:2,FAILED:3,CANCELLED:4},s={url:document.URL,method:"POST",extraData:{},headers:{},maxFileSize:0,allowedTypes:"*",extFilter:null,dataType:null,fileName:"file",auto:!0,skipChecks:!1,onInit:function(){},onFallbackMode:function(){},onNewFile:function(){},onBeforeUpload:function(){},onComplete:function(){},onUploadProgress:function(){},onUploadSuccess:function(){},onUploadError:function(){},onUploadCancel:function(){},onFileTypeError:function(){},onFileSizeError:function(){},onFileExtError:function(){}},i=function(t,n){return this.element=e(t),this.settings=e.extend({},s,n),this.settings.skipChecks||this.checkBrowser()?(this.init(),!0):!1},o=function(e){this.file=e,this.jqXHR=null,this.status=n.PENDING,this.id=-1};o.prototype.setId=function(e){this.id=e},o.prototype.cancel=function(){switch(this.status){case n.PENDING:this.status=n.CANCELLED;break;case n.UPLOADING:this.status=n.CANCELLED,this.jqXHR.abort();break;default:return!1}return!0},o.prototype.upload=function(t,s){var i=this;if(!s&&i.status==n.CANCELLED)return t.processQueue(),!1;if(i.status==n.UPLOADING||i.status==n.COMPLETED)return s||t.processQueue(),!1;var o=new FormData;return o.append(t.settings.fileName,i.file),e.each(t.settings.extraData,function(e,t){"function"==typeof t&&(t=t()),o.append(e,t)}),t.settings.onBeforeUpload.call(t.element,i.id),s||(t.queueRunning=!0),i.status=n.UPLOADING,i.jqXHR=e.ajax({url:t.settings.url,type:t.settings.method,dataType:t.settings.dataType,data:o,headers:t.settings.headers,cache:!1,contentType:!1,processData:!1,forceSync:!1,xhr:function(){var n=e.ajaxSettings.xhr();return n.upload&&n.upload.addEventListener("progress",function(e){var n=0,s=e.loaded||e.position,o=e.total||e.totalSize;e.lengthComputable&&(n=Math.ceil(s/o*100)),t.settings.onUploadProgress.call(t.element,i.id,n)},!1),n},success:function(e){i.status=n.COMPLETED,t.settings.onUploadSuccess.call(t.element,i.id,e)},error:function(e,s,o){i.status!=n.CANCELLED&&(i.status=n.FAILED,t.settings.onUploadError.call(t.element,i.id,o))},complete:function(){t.settings.auto&&t.processQueue()}}),!0},i.prototype.methods={cancel:function(e){if(e>this.queue.length-1)return!1;var t=i.prototype.widget;return t.settings.onUploadCancel.call(t.element,e),this.queue[e].cancel()},cancelAll:function(){var t=0,n=i.prototype.widget;return e.each(this.queue,function(e,s){s.cancel()&&(t++,n.settings.onUploadCancel.call(n.element,e))}),t},start:function(e){return e>this.queue.length-1?!1:this.settings.auto&&e>=this.queuePos?!1:this.queue[e].upload(this,!0)},supportsProgress:function(){var t=e.ajaxSettings.xhr();return void 0!==t.upload},supportsDND:function(){return this.checkEvent("drop",this.element)&&!this.checkEvent("dragstart",this.element)}},i.prototype.checkBrowser=function(){return void 0===window.FormData?(this.settings.onFallbackMode.call(this.element,"Browser doesn't support Form API"),!1):this.element.find("input[type=file]").length>0?!0:this.checkEvent("drop",this.element)&&this.checkEvent("dragstart",this.element)?!0:(this.settings.onFallbackMode.call(this.element,"Browser doesn't support Ajax Drag and Drop"),!1)},i.prototype.checkEvent=function(e,t){t=t||document.createElement("div"),e="on"+e;var n=e in t;return n||(t.setAttribute||(t=document.createElement("div")),t.setAttribute&&t.removeAttribute&&(t.setAttribute(e,""),n="function"==typeof t[e],"undefined"!=typeof t[e]&&(t[e]=void 0),t.removeAttribute(e))),t=null,n},i.prototype.init=function(){var t=this;i.prototype.widget=t,t.queue=[],t.queuePos=-1,t.queueRunning=!1,t.element.on("drop",function(e){e.preventDefault();var n=e.originalEvent.dataTransfer.files;t.queueFiles(n)}),t.element.find("input[type=file]").on("change",function(n){var s=n.target.files;t.queueFiles(s),e(this).val("")}),this.settings.onInit.call(this.element)},i.prototype.queueFiles=function(t){for(var n=this.queue.length,s=0;s<t.length;s++){var i=t[s];if(this.settings.maxFileSize>0&&i.size>this.settings.maxFileSize)this.settings.onFileSizeError.call(this.element,i);else if("*"==this.settings.allowedTypes||i.type.match(this.settings.allowedTypes)){if(null!==this.settings.extFilter){var r=this.settings.extFilter.toLowerCase().split(";"),u=i.name.toLowerCase().split(".").pop();if(e.inArray(u,r)<0){this.settings.onFileExtError.call(this.element,i);continue}}var a=new o(i);this.queue.push(a);var l=this.queue.length-1;a.setId(l),this.settings.onNewFile.call(this.element,l,i)}else this.settings.onFileTypeError.call(this.element,i)}return this.queueRunning?!1:this.queue.length==n?!1:(this.settings.auto&&this.processQueue(),!0)},i.prototype.processQueue=function(){return this.queuePos++,this.queuePos>=this.queue.length?(this.settings.onComplete.call(this.element),this.queuePos=this.queue.length-1,void(this.queueRunning=!1)):void this.queue[this.queuePos].upload(this,!1)},e.fn.dmUploader=function(n){if(1!=e(this).length)return e.error("Need one element to initialize jQuery.dmUploader"),!1;var s=e(this).data(t);return s?s.methods[n]?s.methods[n].apply(s,Array.prototype.slice.call(arguments,1)):(e.error("Method "+n+" does not exist on jQuery.dmUploader"),!1):(e(this).data(t,new i(this,n)),!0)},e(document).on("dragenter",function(e){e.stopPropagation(),e.preventDefault()}),e(document).on("dragover",function(e){e.stopPropagation(),e.preventDefault()}),e(document).on("drop",function(e){e.stopPropagation(),e.preventDefault()})}(jQuery);
